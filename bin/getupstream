#!/bin/zsh

0=${(%):-%N}
ZEPHYR_HOME=${0:A:h:h}
ZEPHYR_CACHE=${XDG_CACHE_HOME:=~/.cache}/zephyr
mkdir -p $ZEPHYR_CACHE

function sedi {
  sed --version &>/dev/null && sed -i -- "$@" || sed -i "" "$@"
}

function _print_zsh_function {
  local filepath=$1
  if [[ ! -f $filepath ]]; then
    echo >&2 "File not found '$filepath'."
    return 1
  fi

  # we don't need a shebang, but it helps syntax highlighters
  echo '#!/bin/zsh'
  # comment everything except the function body
  awk 'BEGIN{c=1}
       c{$0 = "#" $0}
       /^function.+{$/{c=0}
       /() {$/{c=0}
       /^}$/{$0 = "#" $0;c=1}
       {print}' $filepath
}

function _update_clipboard {
  emulate -L zsh

  local omzdir=$ZEPHYR_CACHE/plugins/ohmyzsh
  local clipplug=$ZEPHYR_HOME/plugins/clipboard
  local omzpath name
  for omzpath in lib/clipboard.zsh copyfile copypath copybuffer; do
    name=$omzpath:t:r
    if [[ $name == $omzpath ]]; then
      omzpath=plugins/$name/$name.plugin.zsh
    elif [[ $name == clipboard ]]; then
      name=detect-clipboard
    fi
    _print_zsh_function $omzdir/$omzpath >| $clipplug/functions/$name
  done
}

function _update_completion {
  # https://www.oliverspryn.com/blog/adding-git-completion-to-zsh
  local libdir=$ZEPHYR_HOME/plugins/completion/lib
  local f
  rm $libdir/git-completion.*
  echo "Getting git completions..."
  curl -o $libdir/git-completion.bash https://raw.githubusercontent.com/git/git/master/contrib/completion/git-completion.bash
  curl -o $libdir/git-completion.zsh https://raw.githubusercontent.com/git/git/master/contrib/completion/git-completion.zsh
  echo "Updating zsh-completions..."
  cp -f $ZEPHYR_CACHE/plugins/zsh-completions/src/_* $ZEPHYR_HOME/plugins/completion/completions
}

function _update_editor {

}

function _update_history-substring-search {
}

function _update_terminal {
}

function _update_utility {
  emulate -L zsh

  local zephyr_plugin=$ZEPHYR_HOME/plugins/utility
  local omz_extract_plugin=$ZEPHYR_CACHE/plugins/ohmyzsh/plugins/extract

  _print_zsh_function $omz_extract_plugin/extract.plugin.zsh >| $zephyr_plugin/functions/extract
  cp -f $omz_extract_plugin/_extract $zephyr_plugin/completions
}

function _update_z {
}

function _git_repos {
  local -a repos=(
    agkozak/zsh-z
    ohmyzsh/ohmyzsh
    sorin-ionescu/prezto
    #romkatv/zsh-bench
    #romkatv/zsh-defer
    #sindresorhus/pure
    #zdharma-continuum/fast-syntax-highlighting
    #zsh-users/zsh-autosuggestions
    zsh-users/zsh-completions
    zsh-users/zsh-history-substring-search
  )
  for repo in $repos; do
    repodir=$ZEPHYR_CACHE/plugins/${repo:t}
    if [[ -d $repodir ]]; then
      echo "Refreshing $repo..."
      git -C $repodir pull --ff --rebase --autostash
    else
      echo "Cloning $repo..."
      git clone --depth 1 https://github.com/$repo $repodir
    fi
  done
}

function _getupstream {
  _git_repos
  _update_completion
  _update_clipboard
  _update_terminal
  _update_utility
}

_getupstream $@
